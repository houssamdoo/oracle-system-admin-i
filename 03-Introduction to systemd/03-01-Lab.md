# LAB: Installing Prometheus from a Tarball and Running It as a Systemd Service

## Objective

By the end of this lab, students will:

- Understand how to create a system user for a service
- Manually install Prometheus from a tar.gz archive
- Set up directories and permissions
- Create and configure a systemd service unit
- Start and verify Prometheus as a background service

---

## Prerequisites

- A Linux VM (CentOS, RHEL, Fedora, Ubuntu, etc.)
- A user with sudo privileges
- The Prometheus tarball available at `/home/maximus/prometheus-3.3.1.linux-amd64.tar.gz`

---

## Step 1: Create a system user for Prometheus

```bash
sudo useradd --no-create-home --shell /bin/false prometheus
```

    This creates a system user prometheus without a home directory and prevents login (/bin/false). It is a best practice to run services with minimal privileges.


---

## Step 2: Extract Prometheus tarball

```bash
cd /tmp
tar -xvf /home/maximus/prometheus-3.3.1.linux-amd64.tar.gz
```
We extract the Prometheus package in /tmp, a temporary working directory.

## Step 3: Move extracted folder to /etc/prometheus

```bash
sudo mkdir /etc/prometheus
sudo mv /tmp/prometheus-3.3.1.linux-amd64/prometheus.yml /etc/prometheus/.
```
This will serve as the main configuration directory.

## Step 4: Move the Prometheus binary to /usr/bin

```bash
sudo mv /tmp/prometheus-3.3.1.linux-amd64/prometheus /usr/bin/.
sudo mv /tmp/prometheus-3.3.1.linux-amd64/promtool /usr/bin/.
```
This allows running Prometheus from anywhere in the terminal.

## Step 5: Set ownership of Prometheus directory

```bash
sudo chown -R prometheus:prometheus /etc/prometheus
```

## Step 6: Create data directory for Prometheus

```bash
sudo mkdir /var/lib/prometheus
sudo chown -R prometheus:prometheus /var/lib/prometheus
```
This is where Prometheus stores time series data.

## Step 7: Create the systemd service file

```bash
sudo tee /etc/systemd/system/prometheus.service > /dev/null <<EOF
[Unit]
Description=Prometheus
Wants=network-online.target
After=network-online.target

[Service]
User=prometheus
Group=prometheus
Type=simple
ExecStart=/usr/bin/prometheus \\
  --config.file=/etc/prometheus/prometheus.yml \\
  --storage.tsdb.path=/var/lib/prometheus/ \\
  --web.console.templates=/etc/prometheus/consoles \\
  --web.console.libraries=/etc/prometheus/console_libraries

[Install]
WantedBy=multi-user.target
EOF

```

Step 8: Reload systemd to apply changes

```bash
sudo systemctl daemon-reload
```

Step 9: Start and enable Prometheus

```bash
sudo systemctl start prometheus
sudo systemctl enable prometheus
``` 

Step 10: Verify the status of Prometheus

```bash
sudo systemctl status prometheus
```
You should see an output indicating that Prometheus is active (running).
## Step 11: Access Prometheus Web UI
Open a web browser and navigate to `http://<your-server-ip>:9090`. You should see the Prometheus web interface.
## Step 12: Clean up
```bash
sudo systemctl stop prometheus
sudo systemctl disable prometheus
sudo rm /etc/systemd/system/prometheus.service
sudo rm -rf /etc/prometheus
sudo rm -rf /var/lib/prometheus
sudo rm /usr/bin/prometheus
sudo rm /usr/bin/promtool
sudo userdel prometheus
```
This will remove the Prometheus service and clean up all related files and directories.

## Conclusion
In this lab, you successfully installed Prometheus from a tarball and configured it to run as a systemd service. You learned how to create a system user, set up directories with appropriate permissions, and manage the service using systemd. This foundational knowledge is essential for managing services in a Linux environment effectively.

# Part 2: Installing Grafana
## Step 1: Import the GPG key
```bash
wget -q -O gpg.key https://rpm.grafana.com/gpg.key
sudo rpm --import gpg.key
```
## Step 2: Create Grafana repo file
```bash
sudo tee /etc/yum.repos.d/grafana.repo > /dev/null <<EOF
[grafana]
name=grafana
baseurl=https://rpm.grafana.com
repo_gpgcheck=1
enabled=1
gpgcheck=1
gpgkey=https://rpm.grafana.com/gpg.key
sslverify=1
sslcacert=/etc/pki/tls/certs/ca-bundle.crt
EOF
```
## Step 3: Install Grafana OSS
```bash
sudo dnf install grafana
```
## Step 4: Start and enable Grafana service

```bash
sudo systemctl daemon-reload
sudo systemctl enable grafana-server.service
sudo systemctl start grafana-server.service
sudo systemctl status grafana-server.service
```
# Part 3: Installing Node Exporter

Login to the Prometheus target VM.

## Step 1: Create a system user for Node Exporter
```bash
sudo groupadd -f node_exporter
sudo useradd -g node_exporter --no-create-home --shell /bin/false node_exporter
```

## Step 2: Download and extract Node Exporter
```bash
cd /tmp
wget https://github.com/prometheus/node_exporter/releases/download/v1.9.1/node_exporter-1.9.1.linux-amd64.tar.gz
tar -xvf node_exporter-1.9.1.linux-amd64.tar.gz
```

## Step 3: Move the Node Exporter binary
```bash
sudo mv /tmp/node_exporter-1.9.1.linux-amd64/node_exporter /usr/bin/
sudo chown node_exporter:node_exporter /usr/bin/node_exporter
```

## Step 4: Create the systemd service for Node Exporter
```bash
sudo tee /etc/systemd/system/node-exporter.service > /dev/null <<EOF
[Unit]
Description=Node Exporter
Documentation=https://prometheus.io/docs/guides/node-exporter/
Wants=network-online.target
After=network-online.target

[Service]
User=node_exporter
Group=node_exporter
Type=simple
Restart=on-failure
ExecStart=/usr/bin/node_exporter \\
  --web.listen-address=:9100

[Install]
WantedBy=multi-user.target
EOF
```
```bash
sudo chmod 664 /etc/systemd/system/node-exporter.service
sudo systemctl daemon-reload
sudo systemctl enable node-exporter
sudo systemctl start node-exporter
sudo systemctl status node-exporter
```

This creates and starts Node Exporter as a background service.
## Step 5: Verify Node Exporter
Open a web browser and navigate to `http://<your-server-ip>:9100/metrics`. You should see a list of metrics collected by Node Exporter.